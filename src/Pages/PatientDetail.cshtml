@page "{id:int}"
@model PatientDetailModel
@{
    Layout = null;
    var patient = Model.Patient;
    if (patient == null)
    {
        return;
    }
    var age = DateTime.Now.Year - patient.DateOfBirth.Year;
    if (DateTime.Now < patient.DateOfBirth.AddYears(age)) age--;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patient Details - @patient.FirstName @patient.LastName</title>
    <link rel="stylesheet" href="~/css/patient-detail.css" />
</head>
<body>
    <div class="detail-container">
        <!-- Header Section -->
        <div class="detail-header">
            <div class="header-photo-wrapper">
                <img src="@patient.PhotoUrl" alt="@patient.FirstName @patient.LastName" class="header-photo" />
                <span class="patient-status-indicator" title="Active"></span>
            </div>
            <h1>@patient.FirstName @patient.LastName</h1>
            <div class="patient-id-badge">Patient ID: @patient.Id.ToString("D5")</div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="window.print()">
                    <span>üñ®Ô∏è</span> Print
                </button>
                <button class="action-btn" onclick="exportPatientData()">
                    <span>üìÑ</span> Export
                </button>
                <button class="action-btn" onclick="alert('Edit feature coming soon!')">
                    <span>‚úèÔ∏è</span> Edit
                </button>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs-nav">
            <button class="tab-btn active" data-tab="personal">üìã Personal Info</button>
            <button class="tab-btn" data-tab="contact">üìû Contact</button>
            <button class="tab-btn" data-tab="medical">üè• Medical</button>
            <button class="tab-btn" data-tab="history">üìÖ History</button>
        </div>

        <!-- Content Area -->
        <div class="detail-content">
            <!-- Personal Information Tab -->
            <div class="tab-content active" id="personal-tab">
                <div class="info-section">
                    <h2 class="section-title">
                        <span class="section-icon">üë§</span>
                        Personal Information
                    </h2>
                    <div class="info-grid">
                        <div class="info-card">
                            <div class="info-label">Full Name</div>
                            <div class="info-value">@patient.FirstName @patient.LastName</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">Date of Birth</div>
                            <div class="info-value">@patient.DateOfBirth.ToString("MMMM dd, yyyy")</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">Age</div>
                            <div class="info-value">
                                <span class="badge badge-age">üìÖ @age years old</span>
                            </div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">Gender</div>
                            <div class="info-value">
                                <span class="badge badge-@patient.Gender.ToLower()">
                                    @(patient.Gender == "Male" ? "üë®" : "üë©") @patient.Gender
                                </span>
                            </div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">Blood Type</div>
                            <div class="info-value">
                                <span class="badge badge-blood">ü©∏ @patient.BloodType</span>
                            </div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">Registration Date</div>
                            <div class="info-value">@patient.RegistrationDate.ToString("MMMM dd, yyyy")</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Information Tab -->
            <div class="tab-content" id="contact-tab">
                <div class="info-section">
                    <h2 class="section-title">
                        <span class="section-icon">üìû</span>
                        Contact Information
                    </h2>
                    <div class="info-grid">
                        <div class="info-card">
                            <div class="info-label">Phone Number</div>
                            <div class="info-value">üì± @patient.PhoneNumber</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">Email Address</div>
                            <div class="info-value">üìß @patient.Email</div>
                        </div>
                        <div class="info-card info-card-full">
                            <div class="info-label">Home Address</div>
                            <div class="info-value">üè† @patient.Address</div>
                        </div>
                    </div>
                </div>

                <div class="info-section">
                    <h2 class="section-title">
                        <span class="section-icon">üîî</span>
                        Communication Preferences
                    </h2>
                    <div class="info-grid">
                        <div class="info-card">
                            <div class="info-label">Preferred Method</div>
                            <div class="info-value">Phone Call</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">Best Time to Contact</div>
                            <div class="info-value">9 AM - 5 PM</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Medical Information Tab -->
            <div class="tab-content" id="medical-tab">
                <div class="info-section">
                    <h2 class="section-title">
                        <span class="section-icon">üè•</span>
                        Medical Information
                    </h2>
                    
                    <!-- Allergies Alert -->
                    @if (!string.IsNullOrEmpty(patient.Allergies) && patient.Allergies != "None")
                    {
                        <div class="alert-box danger">
                            <div class="alert-icon">‚ö†Ô∏è</div>
                            <div class="alert-content">
                                <div class="alert-title">Allergies Alert</div>
                                <div class="alert-text">@patient.Allergies</div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert-box success">
                            <div class="alert-icon">‚úÖ</div>
                            <div class="alert-content">
                                <div class="alert-title">No Known Allergies</div>
                                <div class="alert-text">Patient has no recorded allergies</div>
                            </div>
                        </div>
                    }

                    <!-- Medical History -->
                    @if (!string.IsNullOrEmpty(patient.MedicalHistory) && patient.MedicalHistory != "None")
                    {
                        <div class="alert-box info">
                            <div class="alert-icon">üìã</div>
                            <div class="alert-content">
                                <div class="alert-title">Medical History</div>
                                <div class="alert-text">@patient.MedicalHistory</div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert-box success">
                            <div class="alert-icon">‚úÖ</div>
                            <div class="alert-content">
                                <div class="alert-title">No Significant Medical History</div>
                                <div class="alert-text">Patient has no recorded medical conditions</div>
                            </div>
                        </div>
                    }

                    <div class="info-grid" style="margin-top: 1.5rem;">
                        <div class="info-card">
                            <div class="info-label">Blood Type</div>
                            <div class="info-value">ü©∏ @patient.BloodType</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">Patient Status</div>
                            <div class="info-value">‚úÖ Active</div>
                        </div>
                    </div>
                </div>

                <div class="info-section">
                    <h2 class="section-title">
                        <span class="section-icon">üíä</span>
                        Current Medications
                    </h2>
                    <div class="alert-box warning">
                        <div class="alert-icon">üíä</div>
                        <div class="alert-content">
                            <div class="alert-title">Medication Information</div>
                            <div class="alert-text">Please consult the medications module for detailed prescription information</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div class="tab-content" id="history-tab">
                <div class="info-section">
                    <h2 class="section-title">
                        <span class="section-icon">üìÖ</span>
                        Patient Timeline
                    </h2>
                    
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-date">@patient.RegistrationDate.ToString("MMMM dd, yyyy")</div>
                            <div class="timeline-content">
                                <strong>Patient Registration</strong>
                                <p style="margin-top: 0.5rem; color: var(--text-secondary);">
                                    @patient.FirstName @patient.LastName registered as a new patient at Contoso Clinic
                                </p>
                            </div>
                        </div>
                        
                        <div class="timeline-item">
                            <div class="timeline-date">@patient.RegistrationDate.AddDays(7).ToString("MMMM dd, yyyy")</div>
                            <div class="timeline-content">
                                <strong>Initial Consultation</strong>
                                <p style="margin-top: 0.5rem; color: var(--text-secondary);">
                                    Complete medical history and physical examination conducted
                                </p>
                            </div>
                        </div>
                        
                        @if (!string.IsNullOrEmpty(patient.MedicalHistory) && patient.MedicalHistory != "None")
                        {
                            <div class="timeline-item">
                                <div class="timeline-date">@patient.RegistrationDate.AddDays(14).ToString("MMMM dd, yyyy")</div>
                                <div class="timeline-content">
                                    <strong>Medical Record Update</strong>
                                    <p style="margin-top: 0.5rem; color: var(--text-secondary);">
                                        Medical history documented: @patient.MedicalHistory
                                    </p>
                                </div>
                            </div>
                        }
                        
                        <div class="timeline-item">
                            <div class="timeline-date">@DateTime.Now.ToString("MMMM dd, yyyy")</div>
                            <div class="timeline-content">
                                <strong>Current Status</strong>
                                <p style="margin-top: 0.5rem; color: var(--text-secondary);">
                                    Patient record active and up to date
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="info-section">
                    <h2 class="section-title">
                        <span class="section-icon">üìä</span>
                        Visit Statistics
                    </h2>
                    <div class="info-grid">
                        <div class="info-card">
                            <div class="info-label">Total Visits</div>
                            <div class="info-value">@(Math.Max(1, (DateTime.Now - patient.RegistrationDate).Days / 30))</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">Last Visit</div>
                            <div class="info-value">@DateTime.Now.AddDays(-15).ToString("MMM dd, yyyy")</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">Next Appointment</div>
                            <div class="info-value">@DateTime.Now.AddDays(30).ToString("MMM dd, yyyy")</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Close Button -->
        <div class="close-btn-wrapper">
            <button class="close-btn" onclick="window.close()">
                Close Window
            </button>
        </div>
    </div>

    <script>
        // Tab switching functionality
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const targetTab = btn.dataset.tab;
                
                // Remove active class from all tabs and contents
                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                btn.classList.add('active');
                document.getElementById(`${targetTab}-tab`).classList.add('active');
            });
        });

        // Export patient data function
        function exportPatientData() {
            const patientData = {
                id: '@Html.Raw(System.Text.Json.JsonSerializer.Serialize(patient.Id))',
                name: '@Html.Raw(System.Text.Json.JsonSerializer.Serialize($"{patient.FirstName} {patient.LastName}"))',
                dob: '@Html.Raw(System.Text.Json.JsonSerializer.Serialize(patient.DateOfBirth.ToString("yyyy-MM-dd")))',
                age: @age,
                gender: '@Html.Raw(System.Text.Json.JsonSerializer.Serialize(patient.Gender))',
                bloodType: '@Html.Raw(System.Text.Json.JsonSerializer.Serialize(patient.BloodType))',
                phone: '@Html.Raw(System.Text.Json.JsonSerializer.Serialize(patient.PhoneNumber))',
                email: '@Html.Raw(System.Text.Json.JsonSerializer.Serialize(patient.Email))',
                address: '@Html.Raw(System.Text.Json.JsonSerializer.Serialize(patient.Address))',
                allergies: '@Html.Raw(System.Text.Json.JsonSerializer.Serialize(patient.Allergies))',
                medicalHistory: '@Html.Raw(System.Text.Json.JsonSerializer.Serialize(patient.MedicalHistory))',
                registrationDate: '@Html.Raw(System.Text.Json.JsonSerializer.Serialize(patient.RegistrationDate.ToString("yyyy-MM-dd")))'
            };

            const dataStr = JSON.stringify(patientData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'patient_' + patientData.id + '_' + patientData.name.replace(/\s+/g, '_') + '.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                window.close();
            }
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                window.print();
            }
        });

        // Add smooth scrolling
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });
    </script>
</body>
</html>
